# AGENTS.md

Guide for AI agents working on Janee.

## Quick Start

```bash
cd ~/repos/janee
npm install
npm run build
npm test
```

## Repo Structure

```
janee/
├── src/              # TypeScript source
│   ├── core/         # Core functionality (crypto, auth, MCP server)
│   ├── cli/          # CLI commands and config handling
│   └── index.ts      # Main entrypoint
├── dist/             # Built JS (generated by tsc)
├── packages/         # Workspace packages
│   └── openclaw-plugin/  # OpenClaw integration
├── docs/             # Documentation
│   ├── CONTRIBUTING.md   # PR checklist (READ THIS)
│   ├── CHANGELOG.md      # User-facing changes (UPDATE ON RELEASE)
│   ├── POLICIES.md       # Security policies
│   └── rfcs/             # Design documents
├── scripts/          # Build and test scripts
├── SKILL.md          # Agent-facing usage guide
└── README.md         # User-facing docs
```

## Development Workflow

### 1. Pick Up an Issue

```bash
gh issue list
gh issue view <number>
```

Comment on the issue to claim it:
```bash
gh issue comment <number> --body "Working on this"
```

### 2. Create a Branch

```bash
git checkout -b fix/issue-<number>-short-description
# or
git checkout -b feat/issue-<number>-short-description
```

### 3. Make Changes

- Write code in `src/`
- Add tests in `*.test.ts` files (colocated with source)
- Run tests: `npm test`
- Watch mode: `npm run test:watch`
- Build: `npm run build`

### 4. Update Documentation

**Always update (see `docs/CONTRIBUTING.md` for full checklist):**
- [ ] `docs/CHANGELOG.md` — Add entry under `[Unreleased]`
- [ ] Tests for new features or bug fixes

**When applicable:**
- [ ] `README.md` — New CLI commands, features, config options
- [ ] `SKILL.md` — Agent-facing changes (new tools, auth types)
- [ ] `docs/` — Significant features or architecture changes
- [ ] RFC status — Update from Draft → Implemented

### 5. Open a PR

```bash
git push -u origin HEAD
gh pr create --title "fix: <short description>" --body "<what and why>"
```

PR title format:
- `feat: Add feature X`
- `fix: Fix bug Y`
- `docs: Update docs for Z`
- `test: Add tests for W`

### 6. Merge

Once approved and CI passes:
```bash
gh pr merge <number> --squash --delete-branch
```

## Testing

```bash
# Run all tests
npm test

# Watch mode
npm run test:watch

# Run specific test file
npx vitest src/core/rules.test.ts
```

Tests use Vitest. Keep tests colocated with source files (`*.test.ts`).

## Release Process

### 1. Update Version

```bash
# Patch: 0.7.2 → 0.7.3 (bug fixes)
npm version patch

# Minor: 0.7.2 → 0.8.0 (new features)
npm version minor

# Major: 0.7.2 → 1.0.0 (breaking changes)
npm version major
```

This updates `package.json` and creates a git commit + tag.

### 2. Update Changelog

Move `[Unreleased]` entries to new version section:

```markdown
## [Unreleased]

_(empty)_

## [0.7.3] - 2026-02-11

### Fixed
- Bug fix description (#issue)
```

Commit the changelog:
```bash
git add docs/CHANGELOG.md
git commit -m "docs: Update changelog for v0.7.3"
```

### 3. Push

```bash
git push
git push --tags
```

### 4. Publish to npm

```bash
npm publish --access public
```

This publishes `@true-and-useful/janee` to npm.

### 5. Verify

```bash
npm view @true-and-useful/janee version
# Should show the new version
```

## Common Tasks

### Add a New CLI Command

1. Create `src/cli/commands/<command>.ts`
2. Implement command using Commander.js pattern
3. Add tests in `src/cli/commands/<command>.test.ts`
4. Register in `src/cli/index.ts`
5. Update `README.md` with usage examples
6. Update `CHANGELOG.md`

### Add a New Service Directory Template

1. Add entry to `src/core/directory.ts` in `DIRECTORY` object
2. Include `name`, `baseUrl`, `auth`, `scopes` (if OAuth)
3. Test with `janee add <service>`
4. Update `README.md` directory list
5. Update `CHANGELOG.md`

### Add a New Auth Type

1. Implement in `src/core/<auth-type>.ts`
2. Add signing logic to `src/core/signing.ts`
3. Add tests for both modules
4. Update `SKILL.md` if agents need to know
5. Update `docs/POLICIES.md` if security implications
6. Update `CHANGELOG.md`

### Fix a Security Issue

**Extra care required** — Janee is a security product:

1. **Never log credentials** — Check all `console.log`, `audit.log` calls
2. **Validate inputs** — Especially file paths, service names, API keys
3. **Test encryption** — Ensure secrets are encrypted at rest
4. **Document security implications** — In PR description
5. **Consider a security advisory** — For vulnerabilities in released versions

### Implement an RFC

1. Read the RFC in `docs/rfcs/`
2. Reference it in PR description
3. Update RFC status when merged:
   ```markdown
   **Status:** Implemented (v0.8.0, #42)
   ```

## Key Commands

```bash
# Development
npm run build          # Build TypeScript
npm run dev            # Watch mode
npm test               # Run tests
npm run test:watch     # Watch tests

# Git + GitHub
gh issue list          # List issues
gh pr list             # List PRs
gh pr create           # Create PR
gh pr merge <n> --squash --delete-branch  # Merge PR
gh run list            # Check CI status

# Publishing
npm version patch      # Bump version
npm publish --access public  # Publish to npm
git push --tags        # Push tags

# Local testing
janee init             # Initialize config
janee add <service>    # Add service
janee list             # List services
janee serve            # Start MCP server
```

## Links

- **Contributing Guide:** `docs/CONTRIBUTING.md` — **Read this before PRs**
- **Changelog:** `docs/CHANGELOG.md` — Update on every release
- **Security Policies:** `docs/POLICIES.md`
- **RFCs:** `docs/rfcs/` — Design documents
- **GitHub:** https://github.com/rsdouglas/janee
- **npm:** https://www.npmjs.com/package/@true-and-useful/janee

## Commit Message Format

Keep it short and descriptive:
- `feat: Add service account authentication`
- `fix: Handle 401 retry in token refresh`
- `docs: Update changelog for v0.2.0`
- `test: Add caching tests for service accounts`

## Security

This is a **security product**. Extra scrutiny required:

- Secrets must be encrypted at rest
- Never log credentials, tokens, or private keys
- Validate all inputs (especially file paths and service names)
- Document security implications in PRs
- When in doubt, ask for a security review

See `docs/POLICIES.md` for full security policies.
